    {% extends "layout.html" %}

    {% block content %}
    <div class="main-visualization">
        <h1 class="vis-title">Data Visualization</h1>
        <div class="main">
            <!-- Chart Display Section -->
            <div class="main-canvas">
                <!-- Tab Navigation -->
                <div class="tabs-vis">
                    <button class="tab-vis active-tab" id="bar-chart-tab">Bar Chart</button>
                    <button class="tab-vis" id="bubble-chart-tab">Bubble Chart</button>
                    <button class="tab-vis" id="histogram-tab">Histogram</button>
                    <button class="tab-vis" id="pie-chart-tab">Pie Chart</button>
                    <button class="tab-vis" id="radar-chart-tab">Radar Chart</button>
                </div>
                <!-- Canvas for Charts -->
                <div class="canvas">
                    <canvas id="bar-chart" class="chart"></canvas>
                    <canvas id="bubble-chart" class="chart hidden"></canvas>
                    <canvas id="histogram" class="chart hidden"></canvas>
                    <canvas id="pie-chart" class="chart hidden"></canvas>
                    <canvas id="radar-chart" class="chart hidden"></canvas>
                </div>
            </div>

            <!-- Customization Panel -->
            <div class="tabs-cust">
                <div class="customization">
                    <h2 class="cust-title">Customize Charts</h2>

                    <!-- Common Customization -->
                    <label for="x-axis">X-Axis:</label>
                    <select id="x-axis"></select>

                    <label for="y-axis">Y-Axis:</label>
                    <select id="y-axis"></select>

                    <div class="btns">
                        <button class="apply-btn" id="apply-customization">Apply</button>
                        <button id="generate-palette" class="btn btn-primary">Generate Color</button>
                        <button class="apply-btn" id="download-image">Download Image</button>
                        <button class="apply-btn" id="generate-pdf">Generate Report (PDF)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/google-generativeai"></script>

    <script>
        let activeTab = 'bar-chart';  // Define activeTab globally with a default value

        let activeChart;

        // Fetch chart data passed from Flask
        const chartData = JSON.parse('{{ chart_data | safe }}');

        const xAxisDropdown = document.getElementById('x-axis');
        const yAxisDropdown = document.getElementById('y-axis');
        const colorPalettePicker = document.getElementById('color-palette');

        function populateDropdowns() {
            chartData.columns.forEach(column => {
                const xOption = document.createElement('option');
                xOption.value = column;
                xOption.textContent = column;
                xAxisDropdown.appendChild(xOption);

                const yOption = document.createElement('option');
                yOption.value = column;
                yOption.textContent = column;
                yAxisDropdown.appendChild(yOption);
            });

            // Set default selections
            if (chartData.columns.length > 0) {
                xAxisDropdown.value = chartData.columns[0];
                yAxisDropdown.value = chartData.columns[1] || chartData.columns[0];
                }
            }

            document.getElementById('generate-palette').addEventListener('click', function () {
                const paletteColors = generateRandomColors(10); // Generate a palette of 10 colors
                applyPaletteToChart(paletteColors); // Apply the generated colors to the active chart
            });

            // Generate random colors for the palette
            function generateRandomColors(count) {
                const colors = [];
                for (let i = 0; i < count; i++) {
                    const hue = Math.random() * 360; // Random hue
                    const saturation = 70 + Math.random() * 30; // Saturation: 70-100%
                    const lightness = 40 + Math.random() * 20; // Lightness: 40-60%
                    colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
                }
                return colors;
            }

            // Apply the generated palette to the active chart
            function applyPaletteToChart(colors) {
                if (!activeChart) return;

                const chartData = activeChart.data;
                if (chartData.datasets && chartData.datasets[0]) {
                    // Apply colors to the dataset background
                    chartData.datasets[0].backgroundColor = colors.slice(0, chartData.datasets[0].data.length);
                    activeChart.update(); // Update the chart with the new colors
                }
            }

        // Add data loading and pagination functionality
        let fullDataset = null;
        let currentPage = 1;
        const itemsPerPage = 100;

        function loadDatasetInChunks(data) {
            fullDataset = data;
            renderPaginatedData();
        }

        function renderPaginatedData() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            
            const paginatedData = {
                columns: chartData.columns,
                data: {}
            };

            chartData.columns.forEach(column => {
                paginatedData.data[column] = chartData.data[column].slice(startIndex, endIndex);
            });

            return paginatedData;
        }

        function createPaginationControls() {
            const totalPages = Math.ceil(fullDataset.data[fullDataset.columns[0]].length / itemsPerPage);
            
            const paginationContainer = document.createElement('div');
            paginationContainer.classList.add('pagination-controls');
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderChartBasedOnActiveTab();
                }
            });
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderChartBasedOnActiveTab();
                }
            });
            
            // Page info
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            paginationContainer.appendChild(prevButton);
            paginationContainer.appendChild(pageInfo);
            paginationContainer.appendChild(nextButton);
            
            document.querySelector('.customization').appendChild(paginationContainer);
        }

        function renderChart(type, ctx, config) {
            if (activeChart) activeChart.destroy();
            activeChart = new Chart(ctx, config);
        }

        function renderBarChart() {
            const ctx = document.getElementById('bar-chart').getContext('2d');
            const colors = generateRandomColors(chartData.data[xAxisDropdown.value].length);  // Generate random colors for each bar
            renderChart('bar', ctx, {
                type: 'bar',
                data: {
                    labels: chartData.data[xAxisDropdown.value],
                    datasets: [{
                        label: `${xAxisDropdown.value} vs ${yAxisDropdown.value}`,
                        data: chartData.data[yAxisDropdown.value],
                        backgroundColor: colors  // Use the generated colors
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top' // Position the legend to the right of the chart
                        }
                    }
                }
            });
        }

        function renderBubbleChart() {
            const ctx = document.getElementById('bubble-chart').getContext('2d');
            const colors = generateRandomColors(chartData.data[xAxisDropdown.value].length);  // Generate random colors for each bubble
            renderChart('bubble', ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: `${xAxisDropdown.value} vs ${yAxisDropdown.value}`,
                        data: chartData.data[xAxisDropdown.value].map((x, i) => ({
                            x,
                            y: chartData.data[yAxisDropdown.value][i],
                            r: chartData.data[yAxisDropdown.value][i] * 2
                        })),
                        backgroundColor: colors  // Use the generated colors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top' // Position the legend to the right of the chart
                        }
                    }
                }
            });
        }

        function renderHistogram() {
            const ctx = document.getElementById('histogram').getContext('2d');
            const colors = generateRandomColors(chartData.data[xAxisDropdown.value].length);  // Generate random colors for each bar
            renderChart('histogram', ctx, {
                type: 'bar',
                data: {
                    labels: chartData.data[xAxisDropdown.value],
                    datasets: [{
                        label: `${xAxisDropdown.value} Histogram`,
                        data: chartData.data[xAxisDropdown.value],
                        backgroundColor: colors  // Use the generated colors
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top' // Position the legend to the right of the chart
                        }
                    }
                }
            });
        }

        function renderPieChart() {
            const ctx = document.getElementById('pie-chart').getContext('2d');
            const colors = generateRandomColors(chartData.data[xAxisDropdown.value].length);  // Generate random colors for each slice
            renderChart('pie', ctx, {
                type: 'pie',
                data: {
                    labels: chartData.data[xAxisDropdown.value],
                    datasets: [{
                        data: chartData.data[yAxisDropdown.value],
                        backgroundColor: colors  // Use the generated colors
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom' // Position the legend to the right of the chart
                        }
                    }
                }
            });
        }

        function renderRadarChart() {
            const ctx = document.getElementById('radar-chart').getContext('2d');
            const colors = generateRandomColors(chartData.columns.length);  // Generate random colors for each segment
            renderChart('radar', ctx, {
                type: 'radar',
                data: {
                    labels: chartData.columns,
                    datasets: [{
                        label: `${xAxisDropdown.value} vs ${yAxisDropdown.value}`,
                        data: chartData.columns.map(col => chartData.data[col].reduce((a, b) => a + b, 0) / chartData.data[col].length),
                        backgroundColor: colors,
                        borderColor: colors,
                        fill: true
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top' // Position the legend to the right of the chart
                        }
                    }
                }
            });
        }


    document.getElementById('generate-pdf').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            format: 'a4', // Set the page format to A4
            unit: 'mm',   // Use millimeters for measurements
        });

        // Define margins and page size
        const pageWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const marginLeft = 15;
        const marginTop = 20;
        const marginBottom = 20;
        const contentWidth = pageWidth - marginLeft * 2;
        const maxContentHeight = pageHeight - marginTop - marginBottom;

        // Set initial Y position with a margin
        let currentY = marginTop;

        // Add title with margin
        doc.setFontSize(16);
        doc.text('Data Visualization Report', marginLeft, currentY);
        currentY += 10; // Move Y position down after the title

        // Add chart image (convert the active chart to a base64 image)
        let chartImage = null;
        if (activeChart) {
            chartImage = activeChart.toBase64Image();
            doc.addImage(chartImage, 'PNG', marginLeft, currentY, contentWidth, 90); // Adjust image size and position
            currentY += 100; // Move Y position down after the chart image
        }

        // Send a request to Gemini to generate the report, including the chart image and data
        const promptMessage = `
            Generate a detailed report about the following chart:
            Image: ${chartImage} 
            Description: Please provide the response in the following format:
                1. **Report Title:** A brief title that summarizes the content of the report.
                2. **Data Summary:** A short description of the dataset and what it represents.
                3. **Detailed Analysis:**
                - Describe the relationships between the different variables in the dataset.
                - Highlight any significant trends or patterns observed in the data.
                4. **Key Observations:** 
                - Use bullet points to summarize key insights or observations from the data.
                5. **Potential Implications and Further Analysis:**
                - Discuss any further analysis that could be done with the data.
                - Suggest potential applications or uses for the data.
                6. **Visual Representation:** Explain the graph/chart.
                7. **Conclusion:** A concise summary of the findings and their significance.

                Please format the report with headings, bullet points, and numbered lists for better readability.
        `;

        // Function to justify text
        function addJustifiedText(doc, text, x, y, width, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let lines = [];
            words.forEach((word) => {
                const testLine = line + word + ' ';
                const testWidth = doc.getTextWidth(testLine);
                if (testWidth > width) {
                    lines.push(line.trim());
                    line = word + ' ';
                } else {
                    line = testLine;
                }
            });
            lines.push(line.trim());

            lines.forEach((line, index) => {
                const lineWords = line.split(' ');
                if (index === lines.length - 1 || lineWords.length === 1) {
                    // For the last line or single-word lines, align left
                    doc.text(line, x, y);
                } else {
                    // For other lines, distribute spaces evenly
                    const totalSpace = width - doc.getTextWidth(line.replace(/ /g, ''));
                    const spaceWidth = totalSpace / (lineWords.length - 1);
                    let currentX = x;
                    lineWords.forEach((word, i) => {
                        doc.text(word, currentX, y);
                        if (i < lineWords.length - 1) {
                            currentX += doc.getTextWidth(word) + spaceWidth;
                        }
                    });
                }
                y += lineHeight;
            });
            return y; // Return the updated Y position
        }

        // Fetch the report data
        fetch('/generate-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chart_image: chartImage,
                prompt: promptMessage,
                chart_data: chartData,
            }),
        })
            .then((response) => response.json())
            .then((data) => {
                doc.setFontSize(12);
                doc.text('Chart Report:', marginLeft, currentY);
                currentY += 10; // Space before the content

                if (data && data.report) {
                    const paragraphs = data.report.split('\n\n'); // Split into paragraphs
                    paragraphs.forEach((paragraph) => {
                        if (currentY + 10 > maxContentHeight) {
                            doc.addPage(); // Add a new page if content overflows
                            currentY = marginTop; // Reset Y position for the new page
                        }
                        currentY = addJustifiedText(
                            doc,
                            paragraph,
                            marginLeft,
                            currentY,
                            contentWidth,
                            7 // Line height
                        );
                        currentY += 7; // Add spacing between paragraphs
                    });
                } else {
                    doc.text('No report available', marginLeft, currentY);
                }

                // Save the PDF
                doc.save('chart_report.pdf');
            })
            .catch((error) => {
                console.error('Error generating report:', error);
                alert('Error generating report');
            });
    });


        // Event listeners for tabs
        document.querySelectorAll('.tab-vis').forEach(tab => {
            tab.addEventListener('click', function () {
                activeTab = tab.id.replace('-tab', '');  // Update activeTab when a tab is clicked
                document.querySelectorAll('.chart').forEach(c => c.classList.add('hidden'));
                document.getElementById(activeTab).classList.remove('hidden');
                renderChartBasedOnActiveTab();
            });
        });

        // functionality to download the image
        document.getElementById('download-image').addEventListener('click', () => {
            if (activeChart) {
                const imageUrl = activeChart.toBase64Image();  // Get the image as base64
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = 'chart-image.png';  // Set the default download file name
                link.click();  // Trigger the download
            }
        });

        function renderChartBasedOnActiveTab() {
            switch (activeTab) {
                case 'bar-chart': renderBarChart(); break;
                case 'bubble-chart': renderBubbleChart(); break;
                case 'histogram': renderHistogram(); break;
                case 'pie-chart': renderPieChart(); break;
                case 'radar-chart': renderRadarChart(); break;
            }
        }

        // Apply customization and render the selected chart
        document.getElementById('apply-customization').addEventListener('click', () => {
            renderChartBasedOnActiveTab();
        });

        // Initialize dropdowns and render default chart
        document.addEventListener('DOMContentLoaded', () => {
            populateDropdowns();
            renderBarChart();
        });
    </script>

    {% endblock %}
